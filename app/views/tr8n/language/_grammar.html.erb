<div id="grammar_container">
  <%=render(:partial => "header", :locals => {:section => "grammar", :label => "Context Rules", :description => "", :mode => mode})%>

  <% form_for(:language, tr8n_current_language, :url => {:action => :index}, :html => {:id => 'grammar_form', :method => :post}) do |f| %>
    <div class="section_box colored" ondblclick="switchSectionMode('grammar', 'edit')">
      <div style="float:right; padding-right:5px;">
        <%=tr8n_help_icon_tag %>
      </div>
			
			<div style="padding-top:5px;padding-bottom:10px;font-size:12px;">
          <%=trl("Tokens are parts of a phrase that are not translated, such as a profile name or a number.", "Tr8n language management") %> 
					<%=trl("Translations in some languages can depend on the gender or numerical value of the tokens in the phrase.", "Tr8n language management") %>
					<%=trl("For example, the translation for \"{english_sample}\" can depend on the gender of the actor and target as well as the number of photos.", "Tr8n language management", :english_sample => "{actor} tagged {target} in {count} photos")%> 
          <%=trl("If translations in your language depend on any of these rules, you can add them here.", "Tr8n language management") %>
			</div>
						
      <div id="language_rules" style="font-size:12px;">
      	
        <% if @rules.empty? %>
          <%=trl("There are no language rules defined for this language.")%>
        <% end %>
				
        <% if mode == :edit %>
            <%= render(:partial => "rules") %>  
        <% else %>
				    <div style="padding-bottom:15px;">
				    	<%=trl("Translations in this language may depend on the token's:")%>
					  </div>

						<% 
               @types = {}
               @rules.each{|rule| (@types[rule.class.dependency] ||= []) << rule}
               @types.keys.sort.each do |dependency| 
            %>
									<strong><%=dependency%></strong>
									
									<ol style="font-size: 12px; padding-left:10px; margin:1em; list-style-type:square; margin-top:0px;">
									<% @types[dependency].each do |rule| %> 
				              <li style=""><%=rule.description %></li>
									<% end %>	
			            </ol>

            <% end %> 
				<% end %>
      </div>
    </div>
  <% end %>
</div>

<script>
  function submitGrammarRules() {
    if (!confirm("<%=trl('Updating language rules may affect existing translations for this language. Are you sure you want to update this language?') %>")) 
       return;
       
    Tr8n.submit('grammar_form');
  }
  
  function updateLanguageRules(language_id) {
    performLanguageRulesOperation(Tr8n.Utils.serializeForm('grammar_form'));
  }
  
  function addLanguageRule(position) {
    var form_hash = Tr8n.Utils.serializeForm('grammar_form');
    form_hash['rule_action'] = "add_at_" + position;
    performLanguageRulesOperation(form_hash);
  }
  
  function deleteLanguageRule(position) {
    var form_hash = Tr8n.Utils.serializeForm('grammar_form');
    form_hash['rule_action'] = "delete_at_" + position;
    performLanguageRulesOperation(form_hash);
  }
  
  function clearLanguageRules() {
    var form_hash = Tr8n.Utils.serializeForm('grammar_form');
    form_hash['rule_action'] = "clear_all";
    performLanguageRulesOperation(form_hash);
  } 
  
  function performLanguageRulesOperation(params){
    Tr8n.Utils.update('language_rules', '/tr8n/language/update_rules', {
      parameters: params,
      method: 'post'
    });
  }
</script>

